FROM mozmeao/base:python-3.6-alpine

RUN apk add --update --no-cache nodejs postgresql-dev

ENV PATH=/usr/lib/node_modules/standup/node_modules/.bin:$PATH
ENV PIPELINE_LESS_BINARY=lessc
ENV PIPELINE_UGLIFYJS_BINARY=uglifyjs
ENV PIPELINE_CLEANCSS_BINARY=cleancss

# Project settings
ENV DJANGO_SETTINGS_MODULE standup.settings

EXPOSE 8000
CMD ["./bin/run.sh", "prod"]
WORKDIR /app

# First copy requirements.txt so we can take advantage of docker caching.
COPY package.json ./
RUN npm install -g

COPY requirements.txt ./
RUN pip install --require-hashes --no-cache-dir -r requirements.txt

COPY . /app

# process static files
RUN bin/phb-manage.sh collectstatic --noinput
